# üöÄ Despliegue en Vercel - Soluci√≥n de Problemas

## ‚ùå Error 405 - Method Not Allowed

### Problema
```
Failed to load resource: the server responded with a status of 405 ()
```

### Causas Comunes

1. **Funciones Serverless no configuradas correctamente**
2. **Manejo de CORS incorrecto**
3. **M√©todos HTTP no permitidos**
4. **Configuraci√≥n de Vercel incorrecta**

## ‚úÖ Soluciones Implementadas

### 1. Configuraci√≥n de Vercel (`vercel.json`)

```json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "dist"
      }
    },
    {
      "src": "api/**/*.js",
      "use": "@vercel/node"
    }
  ],
  "rewrites": [
    { "source": "/api/(.*)", "destination": "/api/$1" },
    { "source": "/(.*)", "destination": "/index.html" }
  ],
  "functions": {
    "api/**/*.js": {
      "maxDuration": 30
    }
  },
  "headers": [
    {
      "source": "/api/(.*)",
      "headers": [
        {
          "key": "Access-Control-Allow-Origin",
          "value": "*"
        },
        {
          "key": "Access-Control-Allow-Methods",
          "value": "GET, POST, PUT, DELETE, OPTIONS"
        },
        {
          "key": "Access-Control-Allow-Headers",
          "value": "Content-Type, Authorization"
        }
      ]
    }
  ]
}
```

### 2. Funciones Serverless Corregidas

Todas las funciones en `/api/` ahora:
- Usan **ES modules** (`export default`) consistentemente
- Manejan **CORS** correctamente
- Responden a **OPTIONS** requests (preflight)
- Validan m√©todos HTTP

### 3. Endpoints Disponibles

#### Autenticaci√≥n
- `POST /api/auth/register` - Registrar usuario
- `POST /api/auth/login` - Iniciar sesi√≥n
- `POST /api/auth/logout` - Cerrar sesi√≥n

#### Notion API
- `GET /api/databases` - Obtener todas las bases de datos
- `GET /api/database?id=...` - Obtener base de datos espec√≠fica
- `GET /api/test-connection` - Probar conexi√≥n con Notion

#### Utilidades
- `GET /api/hello` - Endpoint de prueba

## üîß Pasos para Desplegar

### 1. Preparar el C√≥digo
```bash
# Asegurarse de que todos los cambios est√©n commitados
git add .
git commit -m "Fix Vercel deployment - 405 error"
```

### 2. Desplegar en Vercel
```bash
# Si usas Vercel CLI
vercel --prod

# O desde el dashboard de Vercel
# 1. Conectar repositorio
# 2. Configurar build settings
# 3. Deploy
```

### 3. Verificar Despliegue
```bash
# Probar endpoints
curl https://tu-app.vercel.app/api/hello
curl -X POST https://tu-app.vercel.app/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"123"}'
```

## üêõ Debugging

### Logs de Vercel
1. Ve al dashboard de Vercel
2. Selecciona tu proyecto
3. Ve a "Functions" para ver logs de serverless functions
4. Ve a "Deployments" para ver logs de build

### Errores Comunes

#### Error: "Cannot find module"
- **Causa**: Dependencias no instaladas
- **Soluci√≥n**: Aseg√∫rate de que `@notionhq/client` est√© en `dependencies`

#### Error: "Function timeout"
- **Causa**: Funci√≥n tarda m√°s de 30 segundos
- **Soluci√≥n**: Optimizar c√≥digo o aumentar `maxDuration`

#### Error: "CORS policy"
- **Causa**: Headers CORS incorrectos
- **Soluci√≥n**: Verificar configuraci√≥n en `vercel.json` y funciones

## üìù Notas Importantes

1. **ES Modules**: Todas las funciones usan `import/export`
2. **CORS**: Configurado tanto en `vercel.json` como en funciones
3. **OPTIONS**: Todas las funciones manejan preflight requests
4. **Error Handling**: Manejo consistente de errores HTTP

## üîç Testing Local

Para probar localmente antes de desplegar:

```bash
# Instalar Vercel CLI
npm i -g vercel

# Probar localmente
vercel dev

# Probar endpoints
curl http://localhost:3000/api/hello
```

## üìû Soporte

Si el error persiste:
1. Revisar logs en Vercel dashboard
2. Verificar que todas las funciones est√©n en `/api/`
3. Confirmar que `vercel.json` est√© en la ra√≠z
4. Verificar que `package.json` tenga `"type": "module"` 