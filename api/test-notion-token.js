import { Client } from '@notionhq/client';

export default async function handler(req, res) {
  // Configurar CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');

  // Manejar preflight requests
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'M√©todo no permitido' });
  }

  try {
    const { token } = req.body;

    if (!token) {
      return res.status(400).json({
        error: 'Token requerido',
        details: 'Debes proporcionar un token de Notion'
      });
    }

    // Validar formato del token
    if (!token.startsWith('secret_') && !token.startsWith('ntn_')) {
      return res.status(400).json({
        error: 'Formato de token inv√°lido',
        details: 'El token debe empezar con "secret_" o "ntn_"',
        tokenPrefix: token.substring(0, 10) + '...'
      });
    }

    console.log('üß™ Probando token de Notion...');

    const notion = new Client({
      auth: token
    });

    // Paso 1: Probar conexi√≥n b√°sica
    console.log('üì° Paso 1: Probando conexi√≥n b√°sica...');
    const botInfo = await notion.users.me();
    
    console.log('‚úÖ Conexi√≥n b√°sica exitosa:', {
      botId: botInfo.id,
      botName: botInfo.name,
      botType: botInfo.type
    });

    // Paso 2: Probar b√∫squeda de bases de datos
    console.log('üîç Paso 2: Buscando bases de datos...');
    const searchResponse = await notion.search({
      filter: {
        value: 'database',
        property: 'object'
      },
      page_size: 10
    });

    console.log('‚úÖ B√∫squeda exitosa:', {
      databasesFound: searchResponse.results.length,
      hasMore: searchResponse.has_more
    });

    // Paso 3: Probar acceso a cada base de datos
    console.log('üìä Paso 3: Probando acceso a bases de datos...');
    const databaseTests = [];

    for (const db of searchResponse.results) {
      try {
        const dbDetails = await notion.databases.retrieve({
          database_id: db.id
        });
        
        databaseTests.push({
          id: db.id,
          title: dbDetails.title?.[0]?.plain_text || 'Sin t√≠tulo',
          accessible: true,
          properties: Object.keys(dbDetails.properties || {}).length
        });
        
        console.log(`‚úÖ Base de datos accesible: ${dbDetails.title?.[0]?.plain_text || db.id}`);
      } catch (error) {
        databaseTests.push({
          id: db.id,
          title: db.title?.[0]?.plain_text || 'Sin t√≠tulo',
          accessible: false,
          error: error.message
        });
        
        console.log(`‚ùå Base de datos no accesible: ${db.id} - ${error.message}`);
      }
    }

    // Resultado final
    const result = {
      success: true,
      message: 'Token v√°lido y funcionando',
      bot: {
        id: botInfo.id,
        name: botInfo.name || 'Integraci√≥n de Notion',
        type: botInfo.type,
        avatar_url: botInfo.avatar_url
      },
      databases: {
        total: searchResponse.results.length,
        accessible: databaseTests.filter(db => db.accessible).length,
        inaccessible: databaseTests.filter(db => !db.accessible).length,
        details: databaseTests
      },
      recommendations: []
    };

    // Agregar recomendaciones
    if (result.databases.inaccessible > 0) {
      result.recommendations.push(
        'Algunas bases de datos no son accesibles. Aseg√∫rate de compartirlas con tu integraci√≥n.'
      );
    }

    if (result.databases.total === 0) {
      result.recommendations.push(
        'No se encontraron bases de datos. Verifica que hayas compartido bases de datos con tu integraci√≥n.'
      );
    }

    if (result.databases.accessible === 0 && result.databases.total > 0) {
      result.recommendations.push(
        'Todas las bases de datos encontradas no son accesibles. Verifica los permisos de tu integraci√≥n.'
      );
    }

    console.log('üéâ Test completado exitosamente');
    return res.status(200).json(result);

  } catch (error) {
    console.error('‚ùå Error en test de token:', error);

    let errorMessage = 'Error desconocido';
    let details = '';

    if (error.code === 'unauthorized') {
      errorMessage = 'Token inv√°lido';
      details = 'El token proporcionado no es v√°lido o ha expirado';
    } else if (error.code === 'restricted_resource') {
      errorMessage = 'Sin permisos';
      details = 'La integraci√≥n no tiene permisos para acceder a los recursos';
    } else if (error.code === 'rate_limited') {
      errorMessage = 'L√≠mite excedido';
      details = 'Se ha excedido el l√≠mite de requests. Intenta de nuevo en unos segundos';
    } else {
      details = error.message || 'Error desconocido al conectar con Notion';
    }

    return res.status(400).json({
      success: false,
      error: errorMessage,
      details: details,
      code: error.code
    });
  }
} 