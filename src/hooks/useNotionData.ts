import { useState, useEffect, useCallback, useMemo } from 'react'
import toast from 'react-hot-toast'
import { NotionDatabase } from '../types/notion'
import { notionAuth } from '../utils/notionAuth'
import { transformNotionDatabase, transformNotionError, validateNotionResponse } from '../utils/notionTransformers'
import { NotionApiClient } from '../utils/notionApi'
import { getDemoData } from '../utils/demoData'

interface UseNotionDataReturn {
  databases: NotionDatabase[]
  loading: boolean
  error: string | null
  isConnected: boolean
  isDemoMode: boolean
  fetchDatabases: () => Promise<void>
  connectWithToken: (token: string) => Promise<void>
  disconnect: () => void
  loadDemoData: () => void
}

// Transformar datos de demo al formato de NotionDatabase
const transformDemoDatabase = (demoDb: any): NotionDatabase => {
  const relations = Object.entries(demoDb.properties)
    .filter(([_, prop]: [string, any]) => prop.type === 'relation')
    .map(([name, prop]: [string, any]) => prop.relation?.database_id)
    .filter(Boolean);

  return {
    id: demoDb.id,
    title: demoDb.title?.[0]?.plain_text || 'Sin t√≠tulo',
    description: demoDb.description?.[0]?.plain_text || '',
    url: `https://notion.so/${demoDb.id}`,
    icon: demoDb.icon,
    cover: demoDb.cover,
    properties: Object.entries(demoDb.properties).reduce((acc, [name, prop]: [string, any]) => {
      acc[name] = {
        id: prop.type === 'relation' ? prop.relation?.database_id : name.toLowerCase().replace(/\s+/g, '_'),
        name,
        type: prop.type,
        options: prop.select?.options || prop.multi_select?.options || [],
        relation: prop.relation // Mantener la informaci√≥n de relaci√≥n para el detector
      };
      return acc;
    }, {} as any),
    relations,
    createdTime: demoDb.created_time,
    lastEditedTime: demoDb.last_edited_time,
    isHidden: demoDb.isHidden || false
  };
};

export function useNotionData(): UseNotionDataReturn {
  const [databases, setDatabases] = useState<NotionDatabase[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [isConnected, setIsConnected] = useState(false)
  const [isDemoMode, setIsDemoMode] = useState(false)
  const [notionClient, setNotionClient] = useState<NotionApiClient | null>(null)

  // Cargar datos de demo
  const loadDemoData = useCallback(() => {
    console.log('üé≠ Iniciando carga de datos de demo...')
    setLoading(true)
    setError(null)
    
    try {
      const demoData = getDemoData()
      const transformedDatabases = demoData.databases.map(transformDemoDatabase)
      
      // Asegurar que el estado est√© limpio antes de cargar demo
      setDatabases(transformedDatabases)
      setIsDemoMode(true)
      setIsConnected(false)
      setNotionClient(null)
      
      toast.success('Modo demo activado - Mostrando datos de demostraci√≥n')
      console.log('‚úÖ Demo mode activated with', transformedDatabases.length, 'databases')
      console.log('üìä Bases de datos cargadas:', transformedDatabases.map(db => db.title))
    } catch (err) {
      console.error('‚ùå Error cargando datos de demo:', err)
      setError('Error cargando datos de demostraci√≥n')
      toast.error('Error cargando datos de demostraci√≥n')
    } finally {
      setLoading(false)
    }
  }, [])

  // Inicializar conexi√≥n si hay token guardado
  useEffect(() => {
    const savedToken = notionAuth.getToken()
    if (savedToken && notionAuth.isValidTokenFormat(savedToken)) {
      // Si hay un token v√°lido guardado, intentar conectar
      const client = new NotionApiClient(savedToken)
      setNotionClient(client)
      setIsConnected(true)
      setIsDemoMode(false)
      console.log('üîë Token encontrado, intentando conectar...')
    } else {
      // Si no hay token v√°lido, cargar demo autom√°ticamente
      console.log('üé≠ No hay token v√°lido, cargando demo...')
      loadDemoData()
    }
  }, [loadDemoData])

  // Conectar con token
  const connectWithToken = useCallback(async (token: string) => {
    setLoading(true)
    setError(null)

    try {
      // Validar formato del token
      if (!notionAuth.isValidTokenFormat(token)) {
        throw new Error('Formato de token inv√°lido. Debe tener 50 caracteres en total comenzando con "ntn_" o 47 caracteres comenzando con "secret_".')
      }

      // Crear cliente de Notion
      const client = new NotionApiClient(token)

      // Probar la conexi√≥n
      const isValid = await client.testConnection()
      
      if (!isValid) {
        throw new Error('No se pudo conectar con Notion. Verifica que el token sea v√°lido y que hayas compartido bases de datos con tu integraci√≥n.')
      }

      // Guardar token y configurar cliente
      notionAuth.saveToken(token)
      setNotionClient(client)
      setIsConnected(true)
      setIsDemoMode(false)
      
      toast.success('¬°Conectado exitosamente a Notion!')
      
      // Cargar bases de datos autom√°ticamente
      await fetchDatabasesWithClient(client)

    } catch (err: any) {
      const errorMessage = transformNotionError(err)
      setError(errorMessage)
      toast.error(errorMessage)
      console.error('Error connecting to Notion:', err)
    } finally {
      setLoading(false)
    }
  }, [])

  // Desconectar
  const disconnect = useCallback(() => {
    console.log('üîí Iniciando proceso de desconexi√≥n...')
    
    // 1. Limpiar token del localStorage (PR√ÅCTICA DE SEGURIDAD)
    notionAuth.removeToken()
    console.log('üóëÔ∏è Token removido del localStorage')
    
    // 2. Limpiar todo el estado de manera s√≠ncrona
    setNotionClient(null)
    setIsConnected(false)
    setIsDemoMode(false)
    setDatabases([])
    setError(null)
    console.log('üßπ Estado limpiado')
    
    toast.success('Desconectado de Notion - Volviendo al modo demo')
    
    // 3. Cargar demo despu√©s de un breve delay para asegurar limpieza
    setTimeout(() => {
      console.log('üé≠ Cargando datos de demo despu√©s de desconexi√≥n...')
      loadDemoData()
    }, 200)
  }, [loadDemoData])

  // Buscar bases de datos con un cliente espec√≠fico
  const fetchDatabasesWithClient = useCallback(async (client: NotionApiClient) => {
    try {
      setError(null)

      // Buscar todas las bases de datos
      const searchResponse = await client.search({
        filter: {
          value: 'database',
          property: 'object'
        },
        page_size: 100
      })

      if (!validateNotionResponse(searchResponse)) {
        throw new Error('Respuesta inv√°lida de la API de Notion')
      }

      // Obtener detalles completos de cada base de datos
      const databasePromises = searchResponse.results.map(async (db: any) => {
        try {
          const databaseDetails = await client.getDatabase(db.id)
          return transformNotionDatabase(databaseDetails)
        } catch (error) {
          console.error(`Error fetching database ${db.id}:`, error)
          return null
        }
      })

      const databaseDetails = await Promise.all(databasePromises)
      const validDatabases = databaseDetails.filter((db): db is NotionDatabase => db !== null)

      setDatabases(validDatabases)
      
      if (validDatabases.length === 0) {
        setError('No se encontraron bases de datos. Aseg√∫rate de haber compartido las bases de datos con tu integraci√≥n.')
      } else {
        toast.success(`${validDatabases.length} bases de datos cargadas`)
      }

    } catch (err: any) {
      const errorMessage = transformNotionError(err)
      setError(errorMessage)
      throw err
    }
  }, [])

  // Buscar bases de datos
  const fetchDatabases = useCallback(async () => {
    if (!notionClient) {
      // Si no hay cliente, cargar demo
      loadDemoData()
      return
    }

    setLoading(true)
    try {
      await fetchDatabasesWithClient(notionClient)
    } catch (err) {
      console.error('Error fetching databases:', err)
    } finally {
      setLoading(false)
    }
  }, [notionClient, fetchDatabasesWithClient, loadDemoData])

  // Cargar datos iniciales solo una vez
  useEffect(() => {
    let isMounted = true
    
    const loadInitialData = async () => {
      console.log('üîÑ Iniciando carga de datos iniciales...')
      
      // Solo cargar datos si hay una conexi√≥n v√°lida
      if (isMounted && notionClient && isConnected) {
        console.log('üîó Cliente Notion disponible, cargando datos reales...')
        await fetchDatabases()
      } else if (isMounted && !notionClient && !isDemoMode && !isConnected) {
        // Si no hay conexi√≥n y no est√° en demo, cargar demo
        console.log('üé≠ No hay conexi√≥n activa, cargando demo...')
        loadDemoData()
      } else if (isMounted && isDemoMode) {
        console.log('üé≠ Ya est√° en modo demo, no hacer nada')
      }
    }
    
    loadInitialData()
    
    return () => {
      isMounted = false
    }
  }, [notionClient, isConnected, isDemoMode, fetchDatabases, loadDemoData])

  return {
    databases,
    loading,
    error,
    isConnected,
    isDemoMode,
    fetchDatabases,
    connectWithToken,
    disconnect,
    loadDemoData
  }
} 